<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>COMSIGHT-like Tank Programming MVP</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; background:#0f1220; color:#e8eaf6; }
      header { padding: 12px 16px; background:#151836; border-bottom: 1px solid #2a2e55; }
      main { display: grid; grid-template-columns: 520px 1fr; gap: 16px; padding: 16px; }
      .panel { background:#141836; border:1px solid #262a51; border-radius:8px; padding:12px; }
      .panel-wide { grid-column: 1 / -1; }
      .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
      button { background:#2a2e55; color:#e8eaf6; border:1px solid #3b3f72; border-radius:6px; padding:6px 10px; cursor:pointer; position:relative; z-index:10; }
      button:disabled { opacity:0.6; cursor:not-allowed; }
      textarea { width:100%; height:180px; background:#0e1230; color:#dfe3ff; border:1px solid #2a2e55; border-radius:6px; padding:8px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }
      canvas { background:#0a0d22; border:1px solid #2a2e55; border-radius:8px; display:block; pointer-events: none; position: relative; z-index: 1; }
      .controls { position: sticky; top: 0; background:#141836; z-index: 20; }
      button:focus { outline: 2px solid #ffd54f; }
      .stats { font-size: 12px; opacity:0.85; }
      .cols { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
      .error { color:#ff8a80; white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    </style>
  </head>
  <body>
    <header>
      <div class="row">
        <strong>COMSIGHT-like MVP</strong>
        <span style="opacity:.75">— Web/TypeScript, polygon renderer</span>
      </div>
    </header>
    <main>
      <section class="panel">
        <canvas id="game" width="512" height="512"></canvas>
        <div class="row controls" style="margin-top:8px; gap:12px; position:relative; z-index:10;">
          <button id="btn-play">Play</button>
          <button id="btn-pause" disabled>Pause</button>
          <button id="btn-step">Step</button>
          <button id="btn-reset">Reset</button>
          <button id="btn-test">Test x10</button>
          <button id="btn-apply">Apply AI</button>
          <label style="display:inline-flex; align-items:center; gap:6px; margin-left:8px;">
            <input type="checkbox" id="auto-play" checked /> Auto Play
          </label>
          <label style="display:inline-flex; align-items:center; gap:6px; margin-left:8px;">
            FP View:
            <input type="radio" name="fpview" id="fp-red" value="0" checked /> Red
            <input type="radio" name="fpview" id="fp-cyan" value="1" /> Cyan
          </label>
          <span class="stats" id="stats"></span>
        </div>
        <div class="stats" id="status" style="margin-top:6px;"></div>
        <div class="error" id="error"></div>
      </section>
      <section class="panel">
        <div class="cols">
          <div>
            <div style="margin-bottom:4px;">AI 1 (Red)</div>
            <div class="row" style="margin:4px 0 6px; gap:8px; align-items:center;">
              <button id="btn-tweet-ai1" title="ツイートする">Tweet My AI</button>
              <span class="stats" style="opacity:.8;">→ #KGNINJA #KOMESAITO</span>
            </div>
            <textarea id="ai1"></textarea>
          </div>
          <div>
            <div style="margin-bottom:4px;">AI 2 (Cyan)</div>
            <div class="row" style="margin:4px 0 6px; gap:8px; align-items:center;">
              <label for="enemy-preset" class="stats" style="opacity:.85;">Enemy Preset:</label>
              <select id="enemy-preset" style="background:#0e1230; color:#dfe3ff; border:1px solid #2a2e55; border-radius:6px; padding:4px 6px;">
                <option value="custom" selected>Custom (editor)</option>
                <option value="aggressive">Aggressive (chaser)</option>
                <option value="runner">Runner (evade)</option>
                <option value="ambush">Ambush (camper)</option>
              </select>
            </div>
            <textarea id="ai2"></textarea>
          </div>
        </div>
        <p class="stats" style="margin-top:8px;">
          JSON rules: first matching rule fires. Conditions: "enemy_ahead", "wall_ahead", "has_scan", "scanning", "scan_ahead", "scan_left", "scan_right", "scan_back", "random&lt;p", "else". Actions: "MOVE", "TURN_LEFT", "TURN_RIGHT", "FIRE", "FIRE_ROCKET", "SCAN", "WAIT".
        </p>
      </section>
      <!-- Wide bottom panel for Third-Person View -->
      <section class="panel panel-wide">
        <div class="stats" style="margin-bottom:6px; opacity:.85;">Third-Person View (chase)</div>
        <canvas id="game3d" width="1152" height="576" style="width:100%; height:auto;"></canvas>
      </section>
    </main>
    <noscript><div style="color:#ff8a80;padding:8px">JavaScriptが無効です。有効にしてください。</div></noscript>
    <script>
      // Inline debug bootstrap: indicates whether any JS runs
      (function(){
        try {
          const s = document.getElementById('status');
          if (s) s.textContent = (s.textContent ? s.textContent + ' | ' : '') + 'Boot: inline JS OK';
          console.log('inline js ok');
          window.addEventListener('error', (e) => {
            const box = document.getElementById('error');
            if (box) box.textContent = 'Error: ' + (e.message || (e.error && e.error.message) || e.filename || 'unknown');
          });
        } catch (err) {
          const box = document.getElementById('error');
          if (box) box.textContent = 'Inline error: ' + (err && err.message ? err.message : String(err));
        }
      })();
    </script>
    <!-- Load ESM directly under HTTP; use dynamic fallback only for file:// -->
    <script type="module" src="./dist/main.js"></script>
    <script type="module">
      if (location.protocol === 'file:') {
        import('./dist/main.js').catch(err => {
          const msg = 'Module load error: ' + (err && err.message ? err.message : String(err));
          const box = document.getElementById('error'); if (box) box.textContent = msg + ' | Falling back to bundle.js?v=3';
          const status = document.getElementById('status'); if (status) status.textContent = (status.textContent? status.textContent + ' | ' : '') + 'Loading fallback...';
          console.error('Module load error', err);
          // Fallback: non-module bundle (cache-busted)
          const s = document.createElement('script'); s.src = './dist/bundle.js?v=3'; s.onload = () => {
            if (status) status.textContent = (status.textContent? status.textContent + ' | ' : '') + 'Fallback loaded v3';
          }; s.onerror = () => { if (box) box.textContent = (box.textContent? box.textContent + ' | ' : '') + ' Fallback load failed'; };
          document.body.appendChild(s);
        });
      }
    </script>
  </body>
  </html>
